generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  username      String
  contact       String?  // 연락처 (전화번호)
  isAdmin       Boolean  @default(false) @map("is_admin")
  currentSport  String   @default("축구") @map("current_sport")
  city          String   @default("서울")
  district      String?
  prismBalance  Int      @default(0) @map("prism_balance") // Prism 포인트 잔액
  lastActiveAt  DateTime @default(now()) @map("last_active_at")
  lastCheckIn   DateTime? @map("last_check_in") // 마지막 출석체크 날짜
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  ownedTeams       Team[]            @relation("TeamOwner")
  teamMembers      TeamMember[]
  approvedMembers  TeamMember[]      @relation("TeamMemberApprover")
  joinRequests     TeamJoinRequest[]
  handledRequests  TeamJoinRequest[] @relation("JoinRequestHandler")
  createdMatches   Match[]           @relation("MatchCreator")
  disputes         Dispute[]
  userMissions     UserMission[]
  prismTransactions PrismTransaction[]
  shortcuts        Shortcut[]
  shortcutLikes    ShortcutLike[]
  shortcutComments ShortcutComment[]

  @@map("users")
}

model Team {
  id           String   @id @default(uuid())
  name         String
  canonicalName String  @map("canonical_name")
  sport        String
  city         String
  district     String
  ownerId      String   @map("owner_id")
  points       Int      @default(0)
  wins         Int      @default(0)
  draws        Int      @default(0)
  losses       Int      @default(0)
  isActive     Boolean  @default(true) @map("is_active")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  description  String?
  maxMembers   Int      @default(20) @map("max_members")
  createdAt    DateTime @default(now()) @map("created_at")

  owner        User                @relation("TeamOwner", fields: [ownerId], references: [id])
  members      TeamMember[]
  joinRequests TeamJoinRequest[]
  homeMatches  Match[]             @relation("HomeTeam")
  awayMatches  Match[]             @relation("AwayTeam")

  @@unique([canonicalName, sport, city, district])
  @@map("teams")
}

model TeamMember {
  id       String   @id @default(uuid())
  teamId   String   @map("team_id")
  userId   String   @map("user_id")
  status   String   @default("active")  // active, pending, rejected, left
  role     String   @default("member")  // member, captain, owner
  message  String?  // 가입 신청 메시지
  joinedAt DateTime @default(now()) @map("joined_at")
  requestedAt DateTime? @map("requested_at")
  approvedAt  DateTime? @map("approved_at")
  approvedBy  String?   @map("approved_by")

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  approver User? @relation("TeamMemberApprover", fields: [approvedBy], references: [id])

  @@unique([teamId, userId])
  @@map("team_members")
}

model TeamJoinRequest {
  id        String   @id @default(uuid())
  teamId    String   @map("team_id")
  userId    String   @map("user_id")
  status    String   @default("pending")  // pending, approved, rejected
  message   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  handledBy String?  @map("handled_by")
  handledAt DateTime? @map("handled_at")

  team    Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user    User @relation(fields: [userId], references: [id], onDelete: Cascade)
  handler User? @relation("JoinRequestHandler", fields: [handledBy], references: [id])

  @@unique([teamId, userId])
  @@map("team_join_requests")
}

model Match {
  id             String    @id @default(uuid())
  sport          String
  homeTeamId     String    @map("home_team_id")
  awayTeamId     String    @map("away_team_id")
  matchDate      DateTime  @map("match_date")
  matchTime      String?   @map("match_time")
  location       String?
  status         String    @default("proposed")
  homeScore      Int?      @map("home_score")
  awayScore      Int?      @map("away_score")
  createdBy      String    @map("created_by")
  contactInfo    String?   @map("contact_info")
  message        String?
  resultEnteredAt DateTime? @map("result_entered_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  homeTeam  Team     @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam  Team     @relation("AwayTeam", fields: [awayTeamId], references: [id])
  creator   User     @relation("MatchCreator", fields: [createdBy], references: [id])
  disputes  Dispute[]

  @@map("matches")
}

model Dispute {
  id         String    @id @default(uuid())
  matchId    String    @map("match_id")
  reportedBy String    @map("reported_by")
  reason     String
  status     String    @default("open")
  adminNotes String?   @map("admin_notes")
  resolvedAt DateTime? @map("resolved_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  match    Match @relation(fields: [matchId], references: [id])
  reporter User  @relation(fields: [reportedBy], references: [id])

  @@map("disputes")
}

model Region {
  id       Int     @id @default(autoincrement())
  city     String
  district String
  isActive Boolean @default(true) @map("is_active")

  @@unique([city, district])
  @@map("regions")
}

model Mission {
  id          String   @id @default(uuid())
  type        String   @unique // SPORT_SELECT, TEAM_JOIN, INVITE_MEMBER, MATCH_VERIFY, DAILY_CHECK_IN, TEAM_MATCH
  title       String
  description String
  reward      Int      // Prism 포인트 보상
  category    String   @default("DAILY") // DAILY, TEAM, MATCH, SPECIAL, PARTNERSHIP
  icon        String?  // 미션 아이콘 (예: trophy, star, users, etc.)
  isRepeatable Boolean @default(false) @map("is_repeatable") // 반복 가능 여부 (출석체크 등)
  isActive    Boolean  @default(true) @map("is_active")
  autoVerify  Boolean  @default(false) @map("auto_verify") // 자동 검증 가능 여부
  verificationRules Json? @map("verification_rules") // 자동 검증 규칙
  order       Int      @default(0)    // 미션 표시 순서
  priority    Int      @default(0)    // 우선순위 (베스트미션 선정용)
  participantCount Int @default(0) @map("participant_count") // 참여자 수
  startDate   DateTime? @map("start_date") // 미션 시작일
  endDate     DateTime? @map("end_date")   // 미션 종료일
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userMissions UserMission[]
  partnerMission PartnerMission?

  @@map("missions")
}

model UserMission {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  missionId   String    @map("mission_id")
  status      String    @default("pending") // pending, completed
  completedAt DateTime? @map("completed_at")
  count       Int       @default(0) // 반복 미션의 경우 완료 횟수
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  mission Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)

  @@unique([userId, missionId])
  @@map("user_missions")
}

model PrismTransaction {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  amount      Int      // 양수: 적립, 음수: 사용
  type        String   // MISSION_REWARD, BOOKING_PAYMENT, etc.
  description String
  missionType String?  @map("mission_type") // 미션으로 인한 적립의 경우 미션 타입
  balanceAfter Int     @map("balance_after") // 거래 후 잔액
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("prism_transactions")
}

// 숏컷 (짧은 영상/이미지 콘텐츠)
model Shortcut {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  title       String?
  content     String?  // 텍스트 내용
  mediaUrl    String?  @map("media_url") // 이미지/비디오 URL
  mediaType   String?  @map("media_type") // image, video
  sport       String?
  likeCount   Int      @default(0) @map("like_count")
  commentCount Int     @default(0) @map("comment_count")
  viewCount   Int      @default(0) @map("view_count")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes    ShortcutLike[]
  comments ShortcutComment[]

  @@map("shortcuts")
}

// 숏컷 좋아요
model ShortcutLike {
  id         String   @id @default(uuid())
  shortcutId String   @map("shortcut_id")
  userId     String   @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")

  shortcut Shortcut @relation(fields: [shortcutId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([shortcutId, userId])
  @@map("shortcut_likes")
}

// 숏컷 댓글
model ShortcutComment {
  id         String   @id @default(uuid())
  shortcutId String   @map("shortcut_id")
  userId     String   @map("user_id")
  content    String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  shortcut Shortcut @relation(fields: [shortcutId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("shortcut_comments")
}

// 제휴사
model Partner {
  id          String   @id @default(uuid())
  name        String
  category    String   // CAFE, STORE, GYM, SPORTS_FACILITY, etc.
  description String?
  logoUrl     String?  @map("logo_url")
  address     String?
  city        String?
  district    String?
  contact     String?
  website     String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  missions PartnerMission[]

  @@map("partners")
}

// 제휴 미션
model PartnerMission {
  id         String   @id @default(uuid())
  partnerId  String   @map("partner_id")
  missionId  String   @unique @map("mission_id")
  conditions Json?    // 제휴 미션 특별 조건
  startDate  DateTime? @map("start_date")
  endDate    DateTime? @map("end_date")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  mission Mission @relation(fields: [missionId], references: [id], onDelete: Cascade)

  @@map("partner_missions")
}